<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>editorapp V3.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&family=Merriweather:wght@400;700&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.min.css" rel="stylesheet" integrity="sha512-/FHUK/LsH78K9XTqsR9hbzr21J8B8RwHR/r8Jv9fzry6NVAOVIGFKQCNINsbhK7a1xubVu2r5QZcz2T9cKpubw==" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js" integrity="sha512-P2W2rr8ikUPfa31PLBo5bcBQrsa+TNj8jiKadtaIrHQGMo6hQM6RdPjQYxlNguwHz8AwSQ28VkBK6kHBLgd/8g==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js" integrity="sha512-pmjEJQ7CveksANaAKdCJZMig7eAcCFFzE1b5XnlnxdB/vU3AOStJ5SF7w4tFuqskuU31ETnAaWTYRQOYg2WHKw==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.2/turndown.min.js" integrity="sha512-7V0hFVI06CJbkXSOgZtdqg40iSPxK+a9nEehUcp299C0elYdeNG+w7ceJ1Ko6WPrLjERkC5pnriiylQWM9Vnpg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous"></script>

<style>
/* ─── RESET & TOKENS ─────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --c-base:       #f0f2f5;
  --c-surface:    #ffffff;
  --c-raised:     #e5e8ed;
  --c-border:     #cdd3da;
  --c-border-hi:  #b0bac4;
  --c-accent:     #009b8e;
  --c-accent-dim: rgba(0,155,142,0.12);
  --c-accent2:    #d46a20;
  --c-text:       #111820;
  --c-text2:      #3d5060;
  --c-text3:      #8098a8;
  --c-danger:     #c03040;
  --c-code:       #0a7050;
  --f-ui:         'Syne', sans-serif;
  --f-mono:       'JetBrains Mono', monospace;
  --f-editor:     'JetBrains Mono', monospace;
  --font-size-editor: 16px;
  --nav-h:        52px;
  --tab-h:        36px;
  --sb-w:         280px;
  --drawer-anim:  0.28s cubic-bezier(0.4, 0, 0.2, 1);
  --split-anim:   0.32s cubic-bezier(0.4, 0, 0.2, 1);
}

html, body {
  height: 100%; overflow: hidden;
  font-family: var(--f-ui);
  background: var(--c-base);
  color: var(--c-text);
  -webkit-font-smoothing: antialiased;
}

/* ─── LAYOUT SHELL ───────────────────────────────────────── */
#app {
  display: flex; flex-direction: column;
  height: 100dvh; overflow: hidden;
  position: relative;
}

/* ─── NAV BAR ────────────────────────────────────────────── */
#navbar {
  height: var(--nav-h);
  display: flex; align-items: center; gap: 0;
  background: var(--c-surface);
  border-bottom: 1px solid var(--c-border);
  flex-shrink: 0; position: relative; z-index: 100;
  padding: 0 4px;
}

.nav-btn {
  display: flex; align-items: center; justify-content: center;
  width: 44px; height: 44px; border-radius: 10px;
  border: none; background: transparent;
  color: var(--c-text2); cursor: pointer;
  transition: background 0.15s, color 0.15s;
  flex-shrink: 0; position: relative;
  -webkit-tap-highlight-color: transparent;
}
.nav-btn:hover  { background: var(--c-raised); color: var(--c-text); }
.nav-btn.active { color: var(--c-accent); }
.nav-btn.active::after {
  content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
  width: 16px; height: 2px; background: var(--c-accent); border-radius: 2px;
}
.nav-btn svg {
  width: 18px; height: 18px; stroke: currentColor; fill: none;
  stroke-width: 1.75; stroke-linecap: round; stroke-linejoin: round;
}

#nav-filename {
  flex: 1; min-width: 0;
  font-family: var(--f-mono); font-size: 13px; font-weight: 500;
  color: var(--c-text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  padding: 0 6px;
}
#nav-filename .path {
  font-size: 10px; color: var(--c-text3); display: block; margin-bottom: 1px; font-weight: 400;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
#nav-filename .name {
  display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.app-ver {
  font-size: 10px; font-weight: 500; letter-spacing: 0.04em;
  color: var(--c-text3); background: var(--c-raised);
  border: 1px solid var(--c-border); border-radius: 3px;
  padding: 1px 5px; margin-left: 6px; vertical-align: middle;
}

.nav-divider { width: 1px; height: 24px; background: var(--c-border); flex-shrink: 0; margin: 0 2px; }

#font-picker, #size-picker {
  height: 28px;
  background: transparent; border: 1px solid var(--c-border);
  color: var(--c-text2); font-family: var(--f-ui); font-size: 11px; font-weight: 600;
  padding: 0 6px; border-radius: 5px; cursor: pointer; outline: none;
  transition: border-color 0.15s, color 0.15s;
  -webkit-appearance: none; appearance: none; vertical-align: middle;
  flex-shrink: 0;
}
#font-picker:hover,  #size-picker:hover  { border-color: var(--c-border-hi); color: var(--c-text); }
#font-picker:focus,  #size-picker:focus  { border-color: var(--c-accent); color: var(--c-text); }
#font-picker option, #size-picker option { background: var(--c-raised); }
#font-picker { margin-left: 4px; margin-right: 2px; }
#size-picker { width: 42px; text-align: center; margin-right: 4px; }

/* ─── WIDE MODE ───────────────────────────────────────────── */
@media (min-width: 768px) {
  body.wide-mode .ql-editor { max-width: none; }
}

/* ─── TAB BAR ────────────────────────────────────────────── */
#tabbar {
  height: var(--tab-h); display: flex; align-items: stretch;
  background: var(--c-base); border-bottom: 1px solid var(--c-border);
  overflow-x: auto; overflow-y: hidden; flex-shrink: 0;
}
#tabbar:empty { display: none; }

.tab {
  display: flex; align-items: center; gap: 6px;
  padding: 0 12px; min-width: 0; max-width: 160px;
  font-size: 11px; font-family: var(--f-mono);
  color: var(--c-text3); cursor: pointer; flex-shrink: 0;
  border-right: 1px solid var(--c-border);
  white-space: nowrap; transition: color 0.12s, background 0.12s;
  position: relative;
}
.tab .tab-name { overflow: hidden; text-overflow: ellipsis; flex: 1; }
.tab:hover { color: var(--c-text2); background: var(--c-raised); }
.tab.active { color: var(--c-text); background: var(--c-surface); }
.tab.active::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 2px; background: var(--c-accent2);
}
.tab-close {
  font-size: 16px; line-height: 1; color: var(--c-text3);
  flex-shrink: 0; border-radius: 4px; padding: 0 2px;
  transition: color 0.1s, background 0.1s;
}
.tab:hover .tab-close { color: var(--c-text2); }
.tab-close:hover { color: var(--c-danger) !important; background: rgba(240,80,96,0.12); }

/* ─── MAIN CONTENT AREA ──────────────────────────────────── */
#content {
  flex: 1; display: flex; overflow: hidden; position: relative; min-height: 0;
}

/* ─── EDITOR PANE ────────────────────────────────────────── */
#editor-pane {
  flex: 1; display: flex; flex-direction: column;
  overflow: hidden; min-width: 0;
  transition: flex var(--split-anim), width var(--split-anim);
}

/* ─── SPLIT DIVIDER ──────────────────────────────────────── */
#split-divider {
  width: 0; background: var(--c-border); flex-shrink: 0;
  overflow: visible; transition: width var(--split-anim);
  position: relative; cursor: col-resize;
}
body.split-active #split-divider { width: 1px; }

/* ─── MARKDOWN PANE ──────────────────────────────────────── */
#md-pane {
  width: 0; flex-shrink: 0; overflow: hidden;
  display: flex; flex-direction: column;
  background: var(--c-base);
  transition: width var(--split-anim);
}
body.split-active #md-pane { width: 40%; }

.md-pane-header {
  height: 36px; display: flex; align-items: center; justify-content: space-between;
  padding: 0 14px; border-bottom: 1px solid var(--c-border);
  background: var(--c-surface); flex-shrink: 0;
}
.md-pane-label {
  font-family: var(--f-mono); font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em; color: var(--c-text3);
}
#md-textarea {
  flex: 1; width: 100%; background: transparent;
  color: var(--c-code); font-family: var(--f-editor);
  font-size: var(--font-size-editor); line-height: 1.8;
  padding: 20px 16px; border: none; outline: none;
  resize: none; overflow-y: auto; tab-size: 2;
}
/* ─── MARKDOWN PANE TABS ─────────────────────────────────── */
#md-tabbar {
  display: flex; align-items: stretch;
  height: var(--tab-h); flex-shrink: 0;
  background: var(--c-base);
  border-bottom: 1px solid var(--c-border);
  overflow-x: auto; overflow-y: hidden;
}
#md-tabbar:empty { display: none; }

.md-tab {
  display: flex; align-items: center;
  padding: 0 11px; min-width: 0; max-width: 140px;
  font-size: 10px; font-family: var(--f-mono);
  color: var(--c-text3); cursor: pointer; flex-shrink: 0;
  border-right: 1px solid var(--c-border);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  transition: color 0.12s, background 0.12s;
  position: relative;
  animation: md-tab-in 0.18s ease;
}
.md-tab:hover { color: var(--c-text2); background: var(--c-raised); }
.md-tab.active {
  color: var(--c-code); background: var(--c-surface);
}
.md-tab.active::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 2px; background: var(--c-accent); border-radius: 0 0 2px 2px;
}

@keyframes md-tab-in {
  from { opacity: 0; transform: translateX(10px); }
  to   { opacity: 1; transform: translateX(0); }
}

/* ─── MOBILE ─────────────────────────────────────────────── */
@media (max-width: 767px) {
  /* Markdown split: full-screen swap */
  body.split-active #md-pane     { width: 100%; }
  body.split-active #editor-pane { width: 0; flex: 0 0 0; overflow: hidden; }
  body.split-active #split-divider { display: none; }

  /* Default font size for mobile */
  :root { --font-size-editor: 15px; }

  /* Drawer becomes a fixed overlay so it doesn't crush the editor */
  #drawer { position: fixed; top: var(--nav-h); left: 0; bottom: 0; height: auto; z-index: 50; }
  body.drawer-open #drawer { width: min(var(--sb-w), 85vw); }

  /* Mobile backdrop — shown when drawer is open, tap to close */
  #mobile-backdrop { display: none; }
  body.drawer-open #mobile-backdrop {
    display: block; position: fixed; inset: 0; top: var(--nav-h);
    background: rgba(0,0,0,0.45); z-index: 49;
    -webkit-tap-highlight-color: transparent;
  }

  /* Hide non-essential navbar items */
  #font-picker, #size-picker, #btn-wide { display: none; }

  /* Markdown button: icon-only to save space */
  #btn-split span { display: none; }
  #btn-split { width: 44px; }

  /* Larger touch targets */
  .tree-row { min-height: 40px; }
  .tree-heading-row { min-height: 28px; }
  .footer-action-btn { height: 44px; }
}

/* ─── EDITOR AREA ────────────────────────────────────────── */
/* Critical: must propagate flex height so .ql-editor can scroll */
#editor-area {
  flex: 1; display: flex; flex-direction: column;
  overflow: hidden; min-height: 0;
}

/* ─── QUILL ──────────────────────────────────────────────── */
#quill-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
#quill-mount { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.ql-toolbar.ql-snow {
  background: var(--c-surface); border: none;
  border-bottom: 1px solid var(--c-border);
  padding: 6px 10px; flex-shrink: 0;
  /* Must be visible — overflow:hidden/auto clips the picker dropdown */
  overflow: visible;
  flex-wrap: nowrap;
}
.ql-container.ql-snow { border: none; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
/* Picker dropdown must float above editor content */
.ql-snow .ql-picker-options { z-index: 500 !important; }

.ql-editor {
  flex: 1; overflow-y: auto;
  background: var(--c-base); color: var(--c-text);
  font-family: var(--f-editor); font-size: var(--font-size-editor); line-height: 1.8;
  padding: 28px 20px; caret-color: var(--c-accent);
  width: 100%; box-sizing: border-box;
}
@media (min-width: 768px) {
  .ql-editor { padding: 40px 48px; max-width: 856px; margin: 0 auto; }
}
/* placeholder intentionally hidden — cursor auto-focuses on open */
.ql-editor.ql-blank::before { display: none; }
.ql-editor h1 {
  font-size: 2em; font-weight: 800; color: var(--c-text);
  margin-bottom: 0.6em; line-height: 1.2;
  border-bottom: 1px solid var(--c-border); padding-bottom: 0.4em;
}
.ql-editor h2 { font-size: 1.45em; font-weight: 700; color: var(--c-text); margin: 1.4em 0 0.4em; }
.ql-editor h3 { font-size: 1.15em; font-weight: 600; color: var(--c-text2); margin: 1.2em 0 0.3em; }
.ql-editor p  { margin-bottom: 0.9em; }
.ql-editor a  { color: var(--c-accent); text-decoration: underline; text-underline-offset: 2px; cursor: pointer; }
.ql-editor strong { color: var(--c-text); }
.ql-editor em     { color: var(--c-text2); }
.ql-editor code {
  font-family: var(--f-mono); font-size: 0.85em;
  background: var(--c-raised); color: var(--c-code);
  padding: 2px 6px; border-radius: 4px; border: 1px solid var(--c-border);
}
.ql-editor pre.ql-syntax {
  font-family: var(--f-mono); font-size: 13px; line-height: 1.6;
  background: var(--c-raised); border: 1px solid var(--c-border);
  border-radius: 8px; padding: 16px; color: var(--c-code); overflow-x: auto;
}
.ql-editor blockquote {
  border-left: 3px solid var(--c-accent); padding-left: 16px;
  color: var(--c-text2); font-style: italic; margin: 1em 0;
}
.ql-editor ul, .ql-editor ol { padding-left: 1.5em; margin-bottom: 0.9em; }
.ql-editor li { margin-bottom: 0.3em; }
.ql-editor table { border-collapse: collapse; margin-bottom: 1em; width: 100%; }
.ql-editor th, .ql-editor td { border: 1px solid var(--c-border); padding: 6px 12px; text-align: left; }
.ql-editor th { background: var(--c-raised); font-weight: 600; }
.ql-editor mark { background: #ffe066; color: #1a1a1a; border-radius: 2px; padding: 0 2px; }
html[data-theme="dark"] .ql-editor mark { background: #7a6000; color: #ffe8a0; }

/* Dark Quill toolbar */
.ql-snow .ql-stroke { stroke: var(--c-text2) !important; }
.ql-snow .ql-fill   { fill:   var(--c-text2) !important; }
.ql-snow .ql-picker  { color: var(--c-text2) !important; }
.ql-snow .ql-picker-options {
  background: var(--c-raised) !important; border-color: var(--c-border) !important;
}
.ql-snow .ql-picker-item { color: var(--c-text2) !important; }
.ql-snow button:hover .ql-stroke, .ql-snow .ql-active .ql-stroke { stroke: var(--c-accent) !important; }
.ql-snow button:hover .ql-fill,   .ql-snow .ql-active .ql-fill   { fill:   var(--c-accent) !important; }
.ql-snow .ql-picker-label:hover,  .ql-snow .ql-active .ql-picker-label { color: var(--c-accent) !important; }

/* ─── EMPTY STATE ────────────────────────────────────────── */
#empty-state {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 12px; color: var(--c-text3); text-align: center; padding: 40px;
}
.empty-mark {
  font-family: var(--f-mono); font-size: 48px; font-weight: 700;
  color: var(--c-accent); opacity: 0.2; line-height: 1;
}
.empty-title { font-size: 15px; font-weight: 600; color: var(--c-text3); }
.empty-sub {
  font-family: var(--f-mono); font-size: 11px; color: var(--c-text3);
  max-width: 260px; line-height: 1.7;
}

/* ─── MAIN AREA (drawer + content side-by-side) ──────────── */
#main-area {
  flex: 1; display: flex; flex-direction: row;
  overflow: hidden; min-height: 0;
}

/* ─── FILE DRAWER ────────────────────────────────────────── */
#drawer {
  width: 0; flex-shrink: 0; overflow: hidden;
  background: var(--c-surface); border-right: 1px solid var(--c-border);
  display: flex; flex-direction: column;
  transition: width var(--drawer-anim);
}
body.drawer-open #drawer { width: var(--sb-w); }

#drawer-header {
  height: var(--nav-h);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 12px 0 16px; border-bottom: 1px solid var(--c-border); flex-shrink: 0;
}
.drawer-title {
  font-family: var(--f-mono); font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.12em; color: var(--c-text3);
}
.drawer-actions { display: flex; gap: 3px; }

#file-tree { flex: 1; overflow-y: auto; padding: 6px 0; }

#drawer-footer {
  border-top: 1px solid var(--c-border); padding: 10px 12px;
  flex-shrink: 0;
}
.drawer-footer-actions { display: flex; gap: 8px; }
.footer-action-wrap { position: relative; flex: 1; }
.footer-action-btn {
  display: flex; align-items: center; justify-content: center; gap: 6px;
  width: 100%; height: 36px; border-radius: 8px;
  border: 1px solid var(--c-border); background: var(--c-raised);
  color: var(--c-text2); font-family: var(--f-mono); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all 0.15s; -webkit-tap-highlight-color: transparent;
}
.footer-action-btn:hover { border-color: var(--c-border-hi); color: var(--c-text); }
.footer-action-btn.open { border-color: var(--c-accent); color: var(--c-accent); background: var(--c-accent-dim); }
.footer-popup {
  position: absolute; bottom: calc(100% + 6px); left: 0; right: 0;
  background: var(--c-surface); border: 1px solid var(--c-border);
  border-radius: 10px; padding: 4px;
  display: none; flex-direction: column; gap: 1px;
  z-index: 200; box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
}
.footer-popup.open { display: flex; }
.footer-popup-item {
  display: flex; align-items: center; gap: 8px;
  width: 100%; text-align: left; padding: 9px 11px;
  border: none; background: transparent; border-radius: 7px;
  font-family: var(--f-mono); font-size: 11px; color: var(--c-text2);
  cursor: pointer; transition: background 0.1s, color 0.1s;
}
.footer-popup-item:hover { background: var(--c-raised); color: var(--c-text); }

/* ─── TREE ITEMS ─────────────────────────────────────────── */
.tree-row {
  display: flex; align-items: center; gap: 5px;
  min-height: 34px; padding: 0 8px;
  cursor: pointer; user-select: none;
  font-size: 13px; font-family: var(--f-mono);
  color: var(--c-text2); transition: background 0.1s, color 0.1s;
  position: relative;
}
.tree-row:hover  { background: var(--c-raised); color: var(--c-text); }
.tree-row.active { background: var(--c-accent-dim); color: var(--c-accent); }
.tree-row.active::before {
  content: ''; position: absolute; left: 0; top: 4px; bottom: 4px;
  width: 2px; background: var(--c-accent); border-radius: 0 2px 2px 0;
}
.row-chevron {
  font-size: 9px; width: 12px; flex-shrink: 0; text-align: center;
  transition: transform 0.15s; color: var(--c-text3);
}
.row-chevron.open { transform: rotate(90deg); }
.row-icon  { font-size: 13px; flex-shrink: 0; width: 16px; text-align: center; }
.row-name  { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.row-actions { display: none; gap: 1px; }
.tree-row:hover .row-actions { display: flex; }
.tree-children.collapsed { display: none; }

/* Drag & drop */
.tree-row.dragging { opacity: 0.3; pointer-events: none; }
.tree-row.drop-into {
  background: var(--c-accent-dim) !important;
  outline: 1px dashed var(--c-accent); outline-offset: -2px;
}
.tree-row.drop-above { box-shadow: 0 -2px 0 0 var(--c-accent) inset; }
.tree-row.drop-below { box-shadow: 0  2px 0 0 var(--c-accent) inset; }

/* ─── BUTTONS ────────────────────────────────────────────── */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 5px;
  padding: 8px 14px; border-radius: 8px;
  border: 1px solid var(--c-border); background: var(--c-raised);
  color: var(--c-text); font-family: var(--f-ui); font-size: 12px;
  font-weight: 600; cursor: pointer; white-space: nowrap;
  transition: all 0.15s; -webkit-tap-highlight-color: transparent;
}
.btn:hover  { border-color: var(--c-border-hi); background: var(--c-border); }
.btn:active { transform: scale(0.97); }
.btn.primary { background: var(--c-accent); border-color: var(--c-accent); color: #000; }
.btn.primary:hover { background: #2de8d8; border-color: #2de8d8; }
.btn.block { width: 100%; }
.btn.sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }
.btn.ghost { background: transparent; border-color: transparent; color: var(--c-text2); }
.btn.ghost:hover { background: var(--c-raised); color: var(--c-text); border-color: var(--c-border); }

.icon-btn {
  display: inline-flex; align-items: center; justify-content: center;
  width: 26px; height: 26px; border-radius: 6px;
  border: none; background: transparent; color: var(--c-text3);
  cursor: pointer; font-size: 12px; transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.icon-btn:hover { background: var(--c-border); color: var(--c-text); }
.icon-btn.danger:hover { color: var(--c-danger); background: rgba(240,80,96,0.1); }

/* ─── MODAL ──────────────────────────────────────────────── */
.modal-overlay {
  position: fixed; inset: 0; z-index: 999;
  background: rgba(0,0,0,0.45); backdrop-filter: blur(4px);
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.modal {
  background: var(--c-surface); border: 1px solid var(--c-border-hi);
  border-radius: 14px; padding: 22px; width: 100%; max-width: 340px;
  box-shadow: 0 24px 64px rgba(0,0,0,0.6);
}
.modal-title  { font-size: 14px; font-weight: 700; margin-bottom: 16px; font-family: var(--f-mono); }
.modal-label  { font-size: 10px; color: var(--c-text3); margin-bottom: 7px; font-family: var(--f-mono); text-transform: uppercase; letter-spacing: 0.08em; }
.modal input {
  width: 100%; padding: 10px 14px;
  background: var(--c-base); border: 1px solid var(--c-border);
  border-radius: 8px; color: var(--c-text);
  font-family: var(--f-mono); font-size: 13px; outline: none; margin-bottom: 16px;
  transition: border-color 0.15s;
}
.modal input:focus { border-color: var(--c-accent); }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; }

/* ─── SCROLLBAR GLOBAL — hidden but scrollable ───────────── */
* { scrollbar-width: none; }
*::-webkit-scrollbar { display: none; }
input[type=file] { display: none; }

/* ─── DARK THEME ─────────────────────────────────────────── */
html[data-theme="dark"] {
  --c-base:       #080b0f;
  --c-surface:    #0e1318;
  --c-raised:     #151c24;
  --c-border:     #1e2a35;
  --c-border-hi:  #2a3a4a;
  --c-accent:     #00d8c8;
  --c-accent-dim: rgba(0,216,200,0.12);
  --c-accent2:    #f0833a;
  --c-text:       #dce8f0;
  --c-text2:      #7a93a6;
  --c-text3:      #3a5060;
  --c-danger:     #f05060;
  --c-code:       #5de8b0;
}
html[data-theme="dark"] .modal-overlay { background: rgba(0,0,0,0.75); }
html[data-theme="dark"] #btn-split { border-color: rgba(0,216,200,0.45); }

/* ─── MARKDOWN SPLIT BUTTON ──────────────────────────────── */
#btn-split {
  width: auto;
  height: 36px;
  padding: 0 12px 0 10px;
  gap: 6px;
  border: 1.5px solid rgba(0,155,142,0.45);
  border-radius: 8px;
  color: var(--c-accent);
  font-family: var(--f-ui);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.03em;
}
#btn-split:hover {
  background: var(--c-accent-dim);
  border-color: var(--c-accent);
  color: var(--c-accent);
}
#btn-split.active {
  background: var(--c-accent);
  border-color: var(--c-accent);
  color: #000;
}
#btn-split.active::after { display: none; }

/* ─── COLLAPSIBLE SECTIONS ──────────────────────────────── */
.ql-section-hidden { display: none !important; }

#collapse-overlay {
  position: absolute; left: 0; top: 0; right: 0; bottom: 0;
  pointer-events: none; z-index: 2; overflow: hidden;
}
.collapse-btn {
  position: absolute; left: 8px;
  width: 20px; height: 20px;
  border: none; background: transparent;
  cursor: pointer; pointer-events: auto;
  color: var(--c-text3); font-size: 9px;
  border-radius: 3px;
  opacity: 0; transition: opacity 0.15s, background 0.15s;
  display: flex; align-items: center; justify-content: center;
  transform: translateY(-50%);
}
.ql-container:hover .collapse-btn { opacity: 0.4; }
.collapse-btn:hover { opacity: 1 !important; background: var(--c-raised); color: var(--c-text); }
.collapse-btn.collapsed { opacity: 1 !important; color: var(--c-accent); }

/* ─── TREE HEADINGS (inline outline in explorer) ─────────── */
.tree-heading-row {
  display: flex; align-items: center; gap: 5px;
  min-height: 22px; padding-right: 8px;
  font-size: 12px; font-family: var(--f-mono);
  color: var(--c-text3); cursor: pointer; user-select: none;
}
.tree-heading-row:hover { background: var(--c-raised); color: var(--c-accent); }
.tree-heading-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: currentColor; flex-shrink: 0;
}

/* ─── MARK / HIGHLIGHT ───────────────────────────────────── */
.ql-editor mark { background: #ffe0661a; color: inherit; border-radius: 2px; padding: 0 2px; }
html[data-theme="dark"] .ql-editor mark { background: rgba(255,200,0,0.18); }
.ql-toolbar .ql-mark.ql-active .ql-fill   { fill:   var(--c-accent) !important; }
.ql-toolbar .ql-mark.ql-active .ql-stroke { stroke: var(--c-accent) !important; }
</style>
</head>
<body>
<div id="app">

  <!-- ── NAV ── -->
  <nav id="navbar">
    <button class="nav-btn" id="btn-drawer" onclick="toggleDrawer()" title="Files (F)">
      <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>

    <div id="nav-filename">
      <span class="path" id="nav-path"></span>
      <span class="name" id="nav-name">editorapp</span>
    </div>

    <button class="nav-btn" id="btn-split" onclick="toggleSplit()" title="Toggle Markdown split (⌘M)">
      <svg viewBox="0 0 24 24">
        <rect x="2"  y="3" width="9" height="18" rx="1.5"/>
        <rect x="13" y="3" width="9" height="18" rx="1.5"/>
      </svg>
      <span>Markdown</span>
    </button>

    <select id="font-picker" title="Editor font" onchange="setFont(this.value)">
      <option value="'JetBrains Mono', monospace" selected>JetBrains Mono</option>
      <option value="'Inter', sans-serif">Inter</option>
      <option value="'Merriweather', serif">Merriweather</option>
    </select>
    <select id="size-picker" title="Font size" onchange="setFontSize(this.value)">
      <option value="13px">13</option>
      <option value="15px">15</option>
      <option value="16px" selected>16</option>
      <option value="18px">18</option>
      <option value="20px">20</option>
    </select>

    <button class="nav-btn" id="btn-wide" onclick="toggleWide()" title="Wide view">
      <svg id="wide-icon" viewBox="0 0 24 24">
        <!-- Expand arrows = currently compact, click for wide -->
        <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
      </svg>
    </button>

    <button class="nav-btn" id="btn-theme" onclick="toggleTheme()" title="Toggle light/dark mode">
      <svg id="theme-icon" viewBox="0 0 24 24">
        <!-- Moon = currently light, click to go dark -->
        <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
      </svg>
    </button>

    <div class="nav-divider"></div>

    <button class="nav-btn" id="btn-save" onclick="saveFile()" title="Save (⌘S)">
      <svg viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
    </button>
  </nav>

  <!-- ── MAIN AREA: DRAWER + CONTENT SIDE BY SIDE ── -->
  <div id="main-area">

    <!-- File drawer (inline push sidebar) -->
    <div id="drawer">
      <div id="drawer-header">
        <span class="drawer-title">Explorer</span>
        <div class="drawer-actions">
          <button class="icon-btn" title="New File" onclick="promptNewFile(null)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
          </button>
          <button class="icon-btn" title="New Folder" onclick="promptNewFolder(null)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
          </button>
          <div class="nav-divider" style="height:16px;margin:0 2px"></div>
          <button class="icon-btn" title="Collapse all" onclick="collapseAll()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="4 14 12 6 20 14"/><polyline points="4 20 12 12 20 20"/>
            </svg>
          </button>
          <button class="icon-btn" title="Expand all" onclick="expandAll()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="4 4 12 12 20 4"/><polyline points="4 10 12 18 20 10"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="file-tree"></div>

      <div id="drawer-footer">
        <div class="drawer-footer-actions">

          <!-- Export button + popup -->
          <div class="footer-action-wrap">
            <button class="footer-action-btn" id="btn-export" onclick="toggleFooterPopup('export')" title="Export">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export
            </button>
            <div class="footer-popup" id="popup-export">
              <button class="footer-popup-item" onclick="exportCurrentFile();closeFooterPopup()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                Current file (.md)
              </button>
              <button class="footer-popup-item" onclick="exportWorkspace();closeFooterPopup()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
                Workspace (.zip)
              </button>
            </div>
          </div>

          <!-- Import button + popup -->
          <div class="footer-action-wrap">
            <button class="footer-action-btn" id="btn-import" onclick="toggleFooterPopup('import')" title="Import">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Import
            </button>
            <div class="footer-popup" id="popup-import">
              <button class="footer-popup-item" onclick="importSingleFile();closeFooterPopup()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                File (.md)
              </button>
              <button class="footer-popup-item" onclick="importWorkspace();closeFooterPopup()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
                Workspace (.zip)
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Editor + markdown panes -->
    <div id="content">

      <!-- Editor pane (always primary) -->
      <div id="editor-pane">
        <div id="tabbar"></div>
        <div id="editor-area">
          <div id="empty-state">
            <div class="empty-mark">#</div>
            <div class="empty-title">No document open</div>
            <div class="empty-sub">Tap the menu to create or open a file</div>
          </div>
        </div>
      </div>

      <!-- Drag-to-resize divider (desktop only) -->
      <div id="split-divider"></div>

      <!-- Markdown pane -->
      <div id="md-pane">
        <div id="md-tabbar"></div>
        <div class="md-pane-header">
          <span class="md-pane-label">Markdown Source</span>
          <button class="btn sm ghost" onclick="copyMarkdown()">Copy</button>
        </div>
        <textarea id="md-textarea" spellcheck="false" placeholder="# markdown appears here…"></textarea>
      </div>

    </div>

  </div>

</div>

<!-- Mobile drawer backdrop -->
<div id="mobile-backdrop"></div>

<!-- Hidden file inputs -->
<input type="file" id="md-file-input"        accept=".md"  onchange="handleImportMd(event)">
<input type="file" id="workspace-file-input" accept=".zip" onchange="handleImportWorkspace(event)">

<script>
// ═══════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════
const APP_VERSION = 'V3.0';
// Markdown files in the repo root to load automatically on startup.
// Adjust this list to match the .md files alongside index.html.
const PRELOAD_FILES = ['GermanA1_Emails.md', 'GermanA1_Cheatsheet.md', 'GermanA1_Speaking.md'];

const S = {
  folders:    [],
  files:      [],
  openTabs:   [],
  activeTab:  null,
  splitOpen:  false,
  drawerOpen: false,
};

// Register a Blot for <hr> so Quill preserves horizontal rules instead of stripping them
const BlockEmbed = Quill.import('blots/block/embed');
class HorizontalRuleBlot extends BlockEmbed {}
HorizontalRuleBlot.blotName = 'hr';
HorizontalRuleBlot.tagName  = 'hr';
Quill.register(HorizontalRuleBlot);

// Register a Blot for <table> so Quill preserves tables instead of stripping them.
// create/value store the innerHTML so content survives the clipboard converter.
class TableBlot extends BlockEmbed {
  static create(value) {
    const node = super.create();
    if (typeof value === 'string') node.innerHTML = value;
    return node;
  }
  static value(node) { return node.innerHTML; }
}
TableBlot.blotName = 'table';
TableBlot.tagName  = 'table';
Quill.register(TableBlot);

// Register a Blot for <mark> so ==highlight== syntax renders correctly.
const Inline = Quill.import('blots/inline');
class MarkBlot extends Inline {}
MarkBlot.blotName = 'mark';
MarkBlot.tagName  = 'mark';
Quill.register(MarkBlot);

let quill = null;
let mdSyncTimer = null;
let isSyncingBack = false;   // prevent quill↔md infinite loop
let collapsedHeadings  = new WeakSet();
let outlineSyncTimer   = null;
let treeExpandedFiles  = new Set();
const TD = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced' });

// marked extension: ==highlight== → <mark>text</mark>
marked.use({
  extensions: [{
    name: 'highlight',
    level: 'inline',
    start(src) { return src.indexOf('=='); },
    tokenizer(src) {
      const m = src.match(/^==([^=\n]+)==/);
      if (m) return { type: 'highlight', raw: m[0], text: m[1] };
    },
    renderer(token) { return `<mark>${token.text}</mark>`; },
  }],
});

// Turndown rule: <mark> → ==text==
TD.addRule('highlight', {
  filter: 'mark',
  replacement: content => `==${content}==`,
});

// Custom Turndown rule: convert <table> back to GFM markdown table syntax
TD.addRule('table', {
  filter: 'table',
  replacement(_content, node) {
    const rows = Array.from(node.querySelectorAll('tr'));
    if (!rows.length) return _content;
    const cellText = cell => cell.textContent.trim().replace(/\|/g, '\\|');
    const rowMd    = row  => '| ' + Array.from(row.querySelectorAll('th,td')).map(cellText).join(' | ') + ' |';
    const header = rowMd(rows[0]);
    const sep    = '| ' + Array.from(rows[0].querySelectorAll('th,td')).map(() => '---').join(' | ') + ' |';
    const body   = rows.slice(1).map(rowMd).join('\n');
    return '\n\n' + header + '\n' + sep + (body ? '\n' + body : '') + '\n\n';
  },
});

// ═══════════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════════
const uid       = () => Date.now().toString(36) + Math.random().toString(36).slice(2,6);
const getFile   = id => S.files.find(f => f.id === id);
const getFolder = id => S.folders.find(f => f.id === id);
const esc       = s  => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const mdExt     = n  => n.endsWith('.md') ? n : n + '.md';

function folderPath(folderId) {
  if (!folderId) return '';
  const parts = [];
  let id = folderId;
  while (id) {
    const f = getFolder(id);
    if (!f) break;
    parts.unshift(f.name);
    id = f.parentId;
  }
  return parts.join(' / ');
}

function htmlToMd(html) {
  if (!html || html === '<p><br></p>') return '';
  return TD.turndown(html);
}
// Strip event-handler attributes, <script> elements, and javascript:/data: URLs
// from HTML produced by marked before it is injected into the DOM.
function sanitizeHtml(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  doc.querySelectorAll('script').forEach(el => el.remove());
  doc.querySelectorAll('*').forEach(el => {
    Array.from(el.attributes).forEach(attr => {
      if (/^on/i.test(attr.name)) el.removeAttribute(attr.name);
      if (/^(href|src|action|formaction)$/i.test(attr.name) &&
          /^(javascript|data):/i.test(attr.value)) el.removeAttribute(attr.name);
    });
  });
  // Quill's BlockquoteBlot is a line blot and cannot have block-level children.
  // marked.parse() wraps blockquote content in <p> tags, which Quill silently
  // drops along with their text. Unwrap them so the text survives.
  doc.querySelectorAll('blockquote p').forEach(p => {
    while (p.firstChild) p.parentNode.insertBefore(p.firstChild, p);
    p.parentNode.removeChild(p);
  });
  return doc.body.innerHTML;
}
function mdToHtml(md) {
  return md ? sanitizeHtml(marked.parse(md)) : '';
}

// ═══════════════════════════════════════════════════════════
// COLLAPSIBLE SECTIONS
// ═══════════════════════════════════════════════════════════
function buildSections() {
  if (!quill) return [];
  const children = Array.from(quill.root.children);
  const sections = [];
  children.forEach((el, i) => {
    const m = el.tagName?.match(/^H([123])$/i);
    if (!m) return;
    const level = parseInt(m[1]);
    const contentEls = [];
    for (let j = i + 1; j < children.length; j++) {
      const nextM = children[j].tagName?.match(/^H([123])$/i);
      if (nextM && parseInt(nextM[1]) <= level) break;
      contentEls.push(children[j]);
    }
    sections.push({ el, level, contentEls });
  });
  return sections;
}

function applyCollapseState() {
  if (!quill) return;
  // Clean slate: remove class from all children first
  Array.from(quill.root.children).forEach(el => el.classList.remove('ql-section-hidden'));
  // Re-apply for collapsed headings
  buildSections().forEach(({ el, contentEls }) => {
    if (collapsedHeadings.has(el)) {
      contentEls.forEach(cel => cel.classList.add('ql-section-hidden'));
    }
  });
  updateCollapseOverlay();
}

function toggleCollapse(headingEl) {
  if (collapsedHeadings.has(headingEl)) {
    collapsedHeadings.delete(headingEl);
  } else {
    collapsedHeadings.add(headingEl);
  }
  applyCollapseState();
}

function collapseAll() {
  // Explorer: collapse all file heading nodes
  treeExpandedFiles.clear();
  renderTree();
  // Editor: collapse all sections in the open document
  if (quill) {
    buildSections().forEach(({ el, contentEls }) => {
      if (contentEls.length > 0) collapsedHeadings.add(el);
    });
    applyCollapseState();
  }
}

function expandAll() {
  // Explorer: expand all files that have headings
  S.files.forEach(f => { if (getFileHeadings(f).length > 0) treeExpandedFiles.add(f.id); });
  renderTree();
  // Editor: expand all sections in the open document
  collapsedHeadings = new WeakSet();
  if (quill) applyCollapseState();
}

function getCleanHTML() {
  if (!quill) return '';
  const hidden = Array.from(quill.root.querySelectorAll('.ql-section-hidden'));
  hidden.forEach(el => el.classList.remove('ql-section-hidden'));
  const html = quill.root.innerHTML;
  hidden.forEach(el => el.classList.add('ql-section-hidden'));
  return html;
}

function updateCollapseOverlay() {
  const overlay = document.getElementById('collapse-overlay');
  if (!overlay || !quill) return;
  overlay.innerHTML = '';
  const sections = buildSections();
  if (!sections.length) return;
  const overlayRect = overlay.getBoundingClientRect();
  const overlayH    = overlayRect.height;
  sections.forEach(({ el, contentEls }) => {
    if (!contentEls.length) return;
    const rect = el.getBoundingClientRect();
    const top  = rect.top - overlayRect.top + rect.height / 2;
    if (top < -20 || top > overlayH + 20) return;
    const isCollapsed = collapsedHeadings.has(el);
    const btn = document.createElement('button');
    btn.className = 'collapse-btn' + (isCollapsed ? ' collapsed' : '');
    btn.textContent = isCollapsed ? '▶' : '▼';
    btn.title       = isCollapsed ? 'Expand section' : 'Collapse section';
    btn.style.top   = top + 'px';
    btn.addEventListener('click', () => toggleCollapse(el));
    overlay.appendChild(btn);
  });
}

function scheduleTreeSync() {
  clearTimeout(outlineSyncTimer);
  outlineSyncTimer = setTimeout(() => { applyCollapseState(); renderTree(); }, 300);
}

// ── Inline heading helpers ──────────────────────────────────
function getFileHeadings(file) {
  if (!file?.htmlContent || file.htmlContent === '<p><br></p>') return [];
  const doc = new DOMParser().parseFromString(file.htmlContent, 'text/html');
  const out = [];
  doc.body.querySelectorAll('h1, h2, h3').forEach(el => {
    out.push({ level: parseInt(el.tagName[1]), text: el.textContent.trim() });
  });
  return out;
}

function toggleTreeExpand(fileId) {
  if (treeExpandedFiles.has(fileId)) treeExpandedFiles.delete(fileId);
  else treeExpandedFiles.add(fileId);
  renderTree();
}

function scrollToHeading(text) {
  if (!quill) return;
  const el = Array.from(quill.root.querySelectorAll('h1, h2, h3'))
    .find(e => e.textContent.trim() === text);
  if (!el) return;
  el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  el.style.transition = 'background 0.2s';
  el.style.background = 'var(--c-accent-dim)';
  setTimeout(() => { el.style.background = ''; el.style.transition = ''; }, 700);
}

// ═══════════════════════════════════════════════════════════
// QUILL
// ═══════════════════════════════════════════════════════════
function initQuill(html) {
  collapsedHeadings = new WeakSet();
  const area = document.getElementById('editor-area');
  area.innerHTML = '<div id="quill-wrap"><div id="quill-mount"></div></div>';

  quill = new Quill('#quill-mount', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['link'], ['clean'],
      ],
    },
  });

  // Add clipboard matchers so our custom BlockEmbed blots survive
  // dangerouslyPasteHTML's HTML→Delta conversion.
  const Delta = Quill.import('delta');
  quill.clipboard.addMatcher('HR', (_node, _delta) =>
    new Delta().insert({ hr: true })
  );
  quill.clipboard.addMatcher('TABLE', (node, _delta) =>
    new Delta().insert({ table: node.innerHTML })
  );

  // Use dangerouslyPasteHTML (HTML→Delta via Quill's clipboard module) instead of
  // directly assigning innerHTML. This correctly handles blockquotes, links inside
  // blockquotes, and all registered inline/block formats — avoiding the silent
  // content loss that Quill's MutationObserver normalization caused with innerHTML.
  if (html) quill.clipboard.dangerouslyPasteHTML(html);

  // Inject HR + Mark buttons into the Quill toolbar
  const toolbar = document.querySelector('.ql-toolbar');
  if (toolbar) {
    const extraGrp = document.createElement('span');
    extraGrp.className = 'ql-formats';

    const hrBtn = document.createElement('button');
    hrBtn.className = 'ql-hr';
    hrBtn.title = 'Insert horizontal rule';
    hrBtn.innerHTML = `<svg viewBox="0 0 18 18"><line class="ql-stroke" x1="2" y1="9" x2="16" y2="9" stroke-linecap="round" stroke-width="2"/></svg>`;
    hrBtn.addEventListener('click', () => {
      const range = quill.getSelection(true);
      if (range) {
        quill.insertEmbed(range.index, 'hr', true, 'user');
        quill.setSelection(range.index + 1, 0, 'user');
      }
    });

    const markBtn = document.createElement('button');
    markBtn.className = 'ql-mark';
    markBtn.title = 'Highlight (==text==)';
    markBtn.innerHTML = `<svg viewBox="0 0 18 18">
      <rect x="2" y="13" width="14" height="3" rx="1.5" class="ql-fill"/>
      <path class="ql-stroke" fill="none" d="M5.5 13L8 4h2l2.5 9"/>
      <line class="ql-stroke" x1="6.5" y1="8" x2="11.5" y2="8"/>
    </svg>`;
    markBtn.addEventListener('click', () => {
      if (!quill) return;
      const fmt = quill.getFormat();
      quill.format('mark', !fmt.mark, 'user');
    });

    extraGrp.appendChild(hrBtn);
    extraGrp.appendChild(markBtn);
    toolbar.appendChild(extraGrp);
  }

  // Inject collapse overlay into .ql-container (outside .ql-editor — safe from Quill's normalizer)
  const qlContainer = document.querySelector('.ql-container');
  if (qlContainer) {
    const overlay = document.createElement('div');
    overlay.id = 'collapse-overlay';
    qlContainer.appendChild(overlay);
    quill.root.addEventListener('scroll', () => requestAnimationFrame(updateCollapseOverlay));
  }

  quill.on('text-change', (_delta, _old, source) => {
    if (source !== 'user') return;   // ignore programmatic changes (md→quill sync)
    const file = getFile(S.activeTab);
    if (file) {
      file.htmlContent  = getCleanHTML();
      file.lastModified = Date.now();
      scheduleMdSync();
      scheduleTreeSync();
    }
  });

  if (S.splitOpen) syncMdPane();
  // Always focus so cursor is visible immediately; position 0 for empty files
  quill.focus();
  if (!html) quill.setSelection(0, 0);
  setTimeout(updateCollapseOverlay, 0);
}

// ═══════════════════════════════════════════════════════════
// MD PANE
// ═══════════════════════════════════════════════════════════
function syncMdPane() {
  const ta = document.getElementById('md-textarea');
  if (!ta) return;
  // Read straight from Quill (never stale) rather than via file.htmlContent
  const html = quill ? quill.root.innerHTML : (getFile(S.activeTab)?.htmlContent || '');
  const md   = html && html !== '<p><br></p>' ? TD.turndown(html) : '';
  if (ta.value !== md) ta.value = md;   // only write if changed (avoids cursor jump)
}

function scheduleMdSync() {
  if (!S.splitOpen) return;
  clearTimeout(mdSyncTimer);
  mdSyncTimer = setTimeout(syncMdPane, 150);   // short debounce — feels live
}

// Allow editing markdown in the split pane and syncing back to Quill
document.getElementById('md-textarea').addEventListener('input', () => {
  const file = getFile(S.activeTab);
  if (!file || !quill) return;
  // Use a separate timer — never cancel the quill→md sync timer (mdSyncTimer)
  clearTimeout(document._mdBackTimer);
  document._mdBackTimer = setTimeout(() => {
    const html = mdToHtml(document.getElementById('md-textarea').value);
    file.htmlContent  = html;
    file.lastModified = Date.now();
    // Setting innerHTML directly is seen as source='api' by Quill,
    // so our text-change guard (source !== 'user') will ignore it — no loop.
    quill.root.innerHTML = html;
  }, 600);
});

function copyMarkdown() {
  const ta = document.getElementById('md-textarea');
  if (!ta) return;
  navigator.clipboard.writeText(ta.value).catch(() => {});
  const btn = document.querySelector('.md-pane-header .btn');
  const orig = btn.textContent;
  btn.textContent = '✓ Copied';
  setTimeout(() => btn.textContent = orig, 1400);
}

// ═══════════════════════════════════════════════════════════
// SPLIT & DRAWER TOGGLES
// ═══════════════════════════════════════════════════════════
function setFont(value) {
  document.documentElement.style.setProperty('--f-editor', value);
}

function toggleSplit() {
  S.splitOpen = !S.splitOpen;
  document.body.classList.toggle('split-active', S.splitOpen);
  document.getElementById('btn-split').classList.toggle('active', S.splitOpen);
  if (S.splitOpen) { syncMdPane(); renderMdTabs(); }
}

// ─── WIDE MODE ────────────────────────────────────────────
let _isWide = false;
function toggleWide() {
  _isWide = !_isWide;
  document.body.classList.toggle('wide-mode', _isWide);
  document.getElementById('btn-wide').classList.toggle('active', _isWide);
  const icon = document.getElementById('wide-icon');
  if (_isWide) {
    // Compress arrows — click to go compact
    icon.innerHTML = '<path d="M8 3v3a2 2 0 01-2 2H3m18 0h-3a2 2 0 01-2-2V3m0 18v-3a2 2 0 012-2h3M3 16h3a2 2 0 012 2v3"/>';
    document.getElementById('btn-wide').title = 'Compact view';
  } else {
    // Expand arrows — click to go wide
    icon.innerHTML = '<path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>';
    document.getElementById('btn-wide').title = 'Wide view';
  }
}

// ─── THEME ────────────────────────────────────────────────
// Follows OS preference; falls back to dark if undetectable.
let _isDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches ?? true;
function applyTheme() {
  const icon = document.getElementById('theme-icon');
  if (_isDark) {
    document.documentElement.setAttribute('data-theme', 'dark');
    // Sun icon — click to return to light
    icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  } else {
    document.documentElement.removeAttribute('data-theme');
    // Moon icon — click to go dark
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
  }
}
function toggleTheme() { _isDark = !_isDark; applyTheme(); }
applyTheme();   // apply on load before first paint

// ─── FONT SIZE ────────────────────────────────────────────
function setFontSize(value) {
  document.documentElement.style.setProperty('--font-size-editor', value);
}

function toggleDrawer() { S.drawerOpen ? closeDrawer() : openDrawer(); }
function openDrawer() {
  S.drawerOpen = true;
  document.body.classList.add('drawer-open');
  document.getElementById('btn-drawer').classList.add('active');
  document.getElementById('drawer').addEventListener('transitionend', updateCollapseOverlay, { once: true });
}
function closeDrawer() {
  S.drawerOpen = false;
  document.body.classList.remove('drawer-open');
  document.getElementById('btn-drawer').classList.remove('active');
  document.getElementById('drawer').addEventListener('transitionend', updateCollapseOverlay, { once: true });
  closeFooterPopup();
}

// ─── FOOTER POPUPS ────────────────────────────────────────
function toggleFooterPopup(id) {
  const other = id === 'export' ? 'import' : 'export';
  document.getElementById('popup-' + other).classList.remove('open');
  document.getElementById('btn-' + other).classList.remove('open');
  const isOpen = document.getElementById('popup-' + id).classList.toggle('open');
  document.getElementById('btn-' + id).classList.toggle('open', isOpen);
}
function closeFooterPopup() {
  ['export', 'import'].forEach(id => {
    document.getElementById('popup-' + id)?.classList.remove('open');
    document.getElementById('btn-' + id)?.classList.remove('open');
  });
}
// Close footer popups and mobile drawer when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.footer-action-wrap')) closeFooterPopup();
});
document.getElementById('mobile-backdrop').addEventListener('click', closeDrawer);

// ═══════════════════════════════════════════════════════════
// RENDER TREE
// ═══════════════════════════════════════════════════════════
function renderTree() {
  const tree = document.getElementById('file-tree');
  tree.innerHTML = '';
  renderLevel(tree, null, 0);
}

// ── drag state ──────────────────────────────────────────────
const drag = { type: null, id: null };   // type: 'file' | 'folder'

function clearDropStyles() {
  document.querySelectorAll('.drop-into,.drop-above,.drop-below,.dragging').forEach(el => {
    el.classList.remove('drop-into','drop-above','drop-below','dragging');
  });
}

function applyDrag(row, type, id) {
  row.setAttribute('draggable', 'true');
  row.addEventListener('dragstart', e => {
    drag.type = type; drag.id = id;
    row.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', id);
  });
  row.addEventListener('dragend', () => { clearDropStyles(); });
}

function applyFolderDrop(row, folderId) {
  row.addEventListener('dragover', e => {
    if (!drag.id || drag.id === folderId) return;
    if (drag.type === 'folder' && isFolderDescendant(folderId, drag.id)) return;
    e.preventDefault(); e.stopPropagation();
    clearDropStyles();
    const rect = row.getBoundingClientRect();
    const zone = (e.clientY - rect.top) / rect.height;
    if (zone < 0.25)      row.classList.add('drop-above');
    else if (zone > 0.75) row.classList.add('drop-below');
    else                  row.classList.add('drop-into');
    e.dataTransfer.dropEffect = 'move';
  });
  row.addEventListener('dragleave', e => {
    if (!row.contains(e.relatedTarget))
      row.classList.remove('drop-into', 'drop-above', 'drop-below');
  });
  row.addEventListener('drop', e => {
    e.preventDefault(); e.stopPropagation();
    if (!drag.id || drag.id === folderId) { clearDropStyles(); return; }
    if (drag.type === 'folder' && isFolderDescendant(folderId, drag.id)) { clearDropStyles(); return; }
    const above = row.classList.contains('drop-above');
    const below = row.classList.contains('drop-below');
    clearDropStyles();
    if (above || below) {
      // Reorder above/below this folder (within its parent)
      const refParent = getFolder(folderId)?.parentId ?? null;
      if (drag.type === 'folder') {
        moveItem('folder', drag.id, 'folder', folderId, refParent, above);
      } else {
        // Move file to the folder's parent level (folders always render before files)
        const f = getFile(drag.id);
        if (f) f.folderId = refParent;
      }
    } else {
      // Drop into folder
      if (drag.type === 'file') {
        const f = getFile(drag.id);
        if (f) f.folderId = folderId;
      } else {
        const f = getFolder(drag.id);
        if (f) f.parentId = folderId;
      }
    }
    renderTree();
  });
}

function applyRowDrop(row, type, id, parentId) {
  // Handles above/below reordering for file rows only;
  // folder rows are fully handled by applyFolderDrop
  row.addEventListener('dragover', e => {
    if (!drag.id || drag.id === id) return;
    if (type === 'folder') return;
    e.preventDefault(); e.stopPropagation();
    clearDropStyles();
    const rect = row.getBoundingClientRect();
    row.classList.add(e.clientY < rect.top + rect.height / 2 ? 'drop-above' : 'drop-below');
    e.dataTransfer.dropEffect = 'move';
  });
  row.addEventListener('dragleave', e => {
    if (!row.contains(e.relatedTarget)) row.classList.remove('drop-above', 'drop-below');
  });
  row.addEventListener('drop', e => {
    e.preventDefault(); e.stopPropagation();
    if (!drag.id || drag.id === id) { clearDropStyles(); return; }
    if (type === 'folder') return;  // let applyFolderDrop handle it
    const above = row.classList.contains('drop-above');
    clearDropStyles();
    moveItem(drag.type, drag.id, type, id, parentId, above);
    renderTree();
  });
}

function isFolderDescendant(targetId, ancestorId) {
  let id = targetId;
  while (id) {
    if (id === ancestorId) return true;
    const f = getFolder(id);
    if (!f) break;
    id = f.parentId;
  }
  return false;
}

function moveItem(srcType, srcId, refType, refId, refParentId, above) {
  if (srcType === 'file') {
    const f = getFile(srcId);
    if (!f) return;
    // Move into same parent as the ref item
    f.folderId = refParentId;
    // Reorder within S.files
    const arr    = S.files;
    const srcIdx = arr.findIndex(x => x.id === srcId);
    const refIdx = arr.findIndex(x => x.id === refId);
    if (srcIdx === -1 || refIdx === -1) return;
    const [item] = arr.splice(srcIdx, 1);
    const newRef  = arr.findIndex(x => x.id === refId);
    arr.splice(above ? newRef : newRef + 1, 0, item);
  } else {
    const f = getFolder(srcId);
    if (!f) return;
    f.parentId = refParentId;
    const arr    = S.folders;
    const srcIdx = arr.findIndex(x => x.id === srcId);
    const refIdx = arr.findIndex(x => x.id === refId);
    if (srcIdx === -1 || refIdx === -1) return;
    const [item] = arr.splice(srcIdx, 1);
    const newRef  = arr.findIndex(x => x.id === refId);
    arr.splice(above ? newRef : newRef + 1, 0, item);
  }
}

function renderLevel(container, parentId, depth) {
  const indent = 10 + depth * 14;

  S.folders.filter(f => f.parentId === parentId).forEach(folder => {
    const wrap = document.createElement('div');
    const row  = document.createElement('div');
    row.className = 'tree-row';
    row.style.paddingLeft = indent + 'px';
    row.innerHTML = `
      <span class="row-chevron ${folder.collapsed ? '' : 'open'}">▶</span>
      <span class="row-icon">📁</span>
      <span class="row-name">${esc(folder.name)}</span>
      <div class="row-actions">
        <button class="icon-btn" title="New file"   onclick="event.stopPropagation();promptNewFile('${folder.id}')">+📄</button>
        <button class="icon-btn" title="New folder" onclick="event.stopPropagation();promptNewFolder('${folder.id}')">+📁</button>
        <button class="icon-btn" title="Rename"     onclick="event.stopPropagation();promptRenameFolder('${folder.id}')">✏</button>
        <button class="icon-btn danger" title="Delete" onclick="event.stopPropagation();deleteFolder('${folder.id}')">✕</button>
      </div>`;
    row.onclick = () => { folder.collapsed = !folder.collapsed; renderTree(); };
    applyDrag(row, 'folder', folder.id);
    applyFolderDrop(row, folder.id);
    applyRowDrop(row, 'folder', folder.id, parentId);

    const kids = document.createElement('div');
    kids.className = 'tree-children' + (folder.collapsed ? ' collapsed' : '');
    wrap.appendChild(row);
    wrap.appendChild(kids);
    container.appendChild(wrap);
    renderLevel(kids, folder.id, depth + 1);
  });

  S.files.filter(f => f.folderId === parentId).forEach(file => {
    const headings   = getFileHeadings(file);
    const hasH       = headings.length > 0;
    const isExpanded = treeExpandedFiles.has(file.id);

    const row = document.createElement('div');
    row.className = 'tree-row' + (S.activeTab === file.id ? ' active' : '');
    // Files with headings get a chevron (same indent as folders); without, skip chevron space
    row.style.paddingLeft = (hasH ? indent : indent + 16) + 'px';
    row.innerHTML = `
      ${hasH ? `<span class="row-chevron${isExpanded ? ' open' : ''}">▶</span>` : ''}
      <span class="row-icon">📄</span>
      <span class="row-name">${esc(file.name)}</span>
      <div class="row-actions">
        <button class="icon-btn" title="Rename" onclick="event.stopPropagation();promptRenameFile('${file.id}')">✏</button>
        <button class="icon-btn danger" title="Delete" onclick="event.stopPropagation();deleteFile('${file.id}')">✕</button>
      </div>`;
    if (hasH) {
      row.querySelector('.row-chevron').addEventListener('click', e => {
        e.stopPropagation();
        toggleTreeExpand(file.id);
      });
    }
    row.onclick = () => { openFile(file.id); };
    applyDrag(row, 'file', file.id);
    applyRowDrop(row, 'file', file.id, parentId);
    container.appendChild(row);

    // Heading rows — shown when file is expanded
    if (hasH && isExpanded) {
      headings.forEach(({ level, text }) => {
        const hRow = document.createElement('div');
        hRow.className = 'tree-heading-row';
        hRow.style.paddingLeft = (indent + 24 + (level - 1) * 8) + 'px';
        const label = document.createElement('span');
        label.style.cssText = 'flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap';
        label.textContent = text || '(untitled)';
        const dot = document.createElement('span');
        dot.className = 'tree-heading-dot';
        hRow.appendChild(dot);
        hRow.appendChild(label);
        hRow.addEventListener('click', () => {
          if (file.id === S.activeTab) {
            scrollToHeading(text);
          } else {
            openFile(file.id);
            setTimeout(() => scrollToHeading(text), 200);
          }
        });
        container.appendChild(hRow);
      });
    }
  });
}

// ═══════════════════════════════════════════════════════════
// RENDER TABS
// ═══════════════════════════════════════════════════════════
function renderTabs() {
  const bar = document.getElementById('tabbar');
  bar.innerHTML = '';
  S.openTabs.forEach(id => {
    const f = getFile(id);
    if (!f) return;
    const tab = document.createElement('div');
    tab.className = 'tab' + (S.activeTab === id ? ' active' : '');
    tab.innerHTML = `<span class="tab-name">${esc(f.name)}</span><span class="tab-close" onclick="event.stopPropagation();closeTab('${id}')">×</span>`;
    tab.onclick = () => switchTab(id);
    bar.appendChild(tab);
    // Scroll active tab into view
    if (S.activeTab === id) setTimeout(() => tab.scrollIntoView({ inline: 'nearest' }), 0);
  });
  renderMdTabs();
}

function renderMdTabs() {
  const bar = document.getElementById('md-tabbar');
  if (!bar) return;
  bar.innerHTML = '';
  S.openTabs.forEach(id => {
    const f = getFile(id);
    if (!f) return;
    const tab = document.createElement('div');
    tab.className = 'md-tab' + (S.activeTab === id ? ' active' : '');
    tab.textContent = f.name;
    tab.title = f.name;
    tab.onclick = () => switchTab(id);
    bar.appendChild(tab);
    if (S.activeTab === id) setTimeout(() => tab.scrollIntoView({ inline: 'nearest', block: 'nearest' }), 0);
  });
}

// ═══════════════════════════════════════════════════════════
// NAV FILENAME
// ═══════════════════════════════════════════════════════════
function updateNav() {
  const f = getFile(S.activeTab);
  document.getElementById('nav-path').textContent = f ? folderPath(f.folderId) : '';
  const nameEl = document.getElementById('nav-name');
  if (f) {
    nameEl.textContent = f.name;
    document.title = f.name + ' — editorapp ' + APP_VERSION;
  } else {
    nameEl.innerHTML = 'editorapp <span class="app-ver">' + APP_VERSION + '</span>';
    document.title = 'editorapp ' + APP_VERSION;
  }
}

// ═══════════════════════════════════════════════════════════
// OPEN / SWITCH / CLOSE TABS
// ═══════════════════════════════════════════════════════════
function openFile(fileId) {
  flushContent();
  if (!S.openTabs.includes(fileId)) S.openTabs.push(fileId);
  S.activeTab = fileId;
  treeExpandedFiles.add(fileId);
  quill = null;
  initQuill(getFile(fileId)?.htmlContent || '');
  renderTabs(); renderTree(); updateNav();
}

function switchTab(fileId) {
  if (fileId === S.activeTab) return;
  flushContent();
  S.activeTab = fileId;
  treeExpandedFiles.add(fileId);
  quill = null;
  initQuill(getFile(fileId)?.htmlContent || '');
  renderTabs(); renderTree(); updateNav();
}

function closeTab(fileId) {
  flushContent();
  S.openTabs = S.openTabs.filter(id => id !== fileId);
  if (S.activeTab === fileId) {
    S.activeTab = S.openTabs[S.openTabs.length - 1] || null;
  }
  quill = null;
  if (S.activeTab) {
    initQuill(getFile(S.activeTab)?.htmlContent || '');
  } else {
    showEmptyState();
  }
  renderTabs(); renderTree(); updateNav();
  if (S.splitOpen) syncMdPane();
}

function showEmptyState() {
  document.getElementById('editor-area').innerHTML = `
    <div id="empty-state">
      <div class="empty-mark">#</div>
      <div class="empty-title">No document open</div>
      <div class="empty-sub">Tap the menu to create or open a file</div>
    </div>`;
}

// ═══════════════════════════════════════════════════════════
// FLUSH CONTENT
// ═══════════════════════════════════════════════════════════
function flushContent() {
  const file = getFile(S.activeTab);
  if (file && quill) {
    file.htmlContent  = getCleanHTML();
    file.lastModified = Date.now();
  }
}

// ═══════════════════════════════════════════════════════════
// SAVE
// ═══════════════════════════════════════════════════════════
function saveFile() {
  flushContent();
  const btn  = document.getElementById('btn-save');
  const prev = btn.style.color;
  btn.style.color = 'var(--c-accent)';
  setTimeout(() => btn.style.color = prev || '', 1200);
}

// ═══════════════════════════════════════════════════════════
// CRUD — FILES & FOLDERS
// ═══════════════════════════════════════════════════════════
function promptNewFile(folderId) {
  showModal('New File', 'Filename:', '', name => {
    if (!name) return;
    const file = { id: uid(), name: mdExt(name), folderId: folderId || null, htmlContent: '', lastModified: Date.now() };
    S.files.push(file);
    renderTree(); openFile(file.id);
  });
}
function promptNewFolder(parentId) {
  showModal('New Folder', 'Folder name:', '', name => {
    if (!name) return;
    S.folders.push({ id: uid(), name, parentId: parentId || null, collapsed: false });
    renderTree();
  });
}
function promptRenameFile(fileId) {
  const f = getFile(fileId);
  if (!f) return;
  showModal('Rename', 'New name:', f.name, name => {
    if (!name) return;
    f.name = mdExt(name);
    renderTree(); renderTabs(); updateNav();
  });
}
function promptRenameFolder(folderId) {
  const f = getFolder(folderId);
  if (!f) return;
  showModal('Rename Folder', 'New name:', f.name, name => {
    if (!name) return;
    f.name = name; renderTree();
  });
}
function deleteFile(fileId) {
  if (!confirm('Delete this file?')) return;
  closeTab(fileId);
  S.files = S.files.filter(f => f.id !== fileId);
  renderTree();
}
function deleteFolder(folderId) {
  if (!confirm('Delete this folder and all its contents?')) return;
  deleteFolderRecursive(folderId);
  renderTree();
}
function deleteFolderRecursive(folderId) {
  S.files.filter(f => f.folderId === folderId).forEach(f => {
    S.openTabs = S.openTabs.filter(id => id !== f.id);
    if (S.activeTab === f.id) { S.activeTab = null; }
  });
  S.files   = S.files.filter(f => f.folderId !== folderId);
  S.folders.filter(f => f.parentId === folderId).forEach(f => deleteFolderRecursive(f.id));
  S.folders = S.folders.filter(f => f.id !== folderId);
  if (!S.activeTab) { quill = null; showEmptyState(); renderTabs(); updateNav(); }
}

// ═══════════════════════════════════════════════════════════
// IMPORT / EXPORT
// ═══════════════════════════════════════════════════════════
function exportCurrentFile() {
  if (!S.activeTab) { alert('No file open.'); return; }
  flushContent();
  const file = getFile(S.activeTab);
  dl(file.name, new Blob([htmlToMd(file.htmlContent || '')], { type: 'text/markdown' }));
}

function importSingleFile() { document.getElementById('md-file-input').click(); }

function handleImportMd(e) {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const file = { id: uid(), name: f.name, folderId: null, htmlContent: mdToHtml(ev.target.result), lastModified: Date.now() };
    S.files.push(file);
    renderTree(); openFile(file.id);
  };
  r.readAsText(f);
  e.target.value = '';
}

function exportWorkspace() {
  flushContent();
  const zip = new JSZip();
  S.files.forEach(file => {
    const fp   = folderPath(file.folderId);
    const path = fp ? fp.replace(/ \/ /g, '/') + '/' + file.name : file.name;
    zip.file(path, htmlToMd(file.htmlContent || ''));
  });
  zip.generateAsync({ type: 'blob' }).then(blob => dl('editorapp-workspace.zip', blob));
}

function importWorkspace() { document.getElementById('workspace-file-input').click(); }

function handleImportWorkspace(e) {
  const f = e.target.files[0];
  if (!f) return;
  JSZip.loadAsync(f).then(zip => {
    S.folders = []; S.files = []; S.openTabs = []; S.activeTab = null; quill = null;
    const folderMap = {}, promises = [];
    zip.forEach((path, entry) => {
      if (entry.dir || !path.endsWith('.md')) return;
      const parts  = path.split('/');
      const fname  = parts.pop();
      let parentId = null;
      parts.forEach((part, i) => {
        const key = parts.slice(0, i + 1).join('/');
        if (!folderMap[key]) {
          const folder = { id: uid(), name: part, parentId, collapsed: false };
          S.folders.push(folder);
          folderMap[key] = folder.id;
        }
        parentId = folderMap[key];
      });
      promises.push(entry.async('string').then(md => {
        S.files.push({ id: uid(), name: fname, folderId: parentId, htmlContent: mdToHtml(md), lastModified: Date.now() });
      }));
    });
    Promise.all(promises).then(() => {
      showEmptyState(); renderTree(); renderTabs(); updateNav();
    });
  }).catch(err => alert('Import failed: ' + err.message));
  e.target.value = '';
}

function dl(filename, blob) {
  const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: filename });
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(a.href), 8000);
}

// ═══════════════════════════════════════════════════════════
// MODAL
// ═══════════════════════════════════════════════════════════
function showModal(title, label, defaultVal, cb) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-title">${esc(title)}</div>
      <div class="modal-label">${esc(label)}</div>
      <input id="_mi" type="text" value="${esc(defaultVal)}" autocomplete="off">
      <div class="modal-actions">
        <button class="btn sm ghost" id="_mc">Cancel</button>
        <button class="btn sm primary" id="_mo">Create</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  const input = overlay.querySelector('#_mi');
  input.focus(); input.select();
  const ok = () => { document.body.removeChild(overlay); cb(input.value.trim()); };
  const no = () => document.body.removeChild(overlay);
  overlay.querySelector('#_mo').onclick = ok;
  overlay.querySelector('#_mc').onclick = no;
  overlay.onclick = no;
  input.onkeydown = e => { if (e.key === 'Enter') ok(); if (e.key === 'Escape') no(); };
}

// ═══════════════════════════════════════════════════════════
// SPLIT DIVIDER DRAG (desktop)
// ═══════════════════════════════════════════════════════════
(function () {
  const divider = document.getElementById('split-divider');
  const mdPane  = document.getElementById('md-pane');
  let drag = false, startX, startW;
  divider.addEventListener('mousedown', e => {
    if (!S.splitOpen) return;
    drag = true; startX = e.clientX; startW = mdPane.offsetWidth;
    document.body.style.cursor     = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if (!drag) return;
    const totalW = document.getElementById('content').offsetWidth;
    const delta  = startX - e.clientX;
    const newW   = Math.max(200, Math.min(totalW * 0.65, startW + delta));
    mdPane.style.width = newW + 'px';
    // Disable CSS transition while dragging
    mdPane.style.transition = 'none';
  });
  document.addEventListener('mouseup', () => {
    if (!drag) return;
    drag = false;
    document.body.style.cursor     = '';
    document.body.style.userSelect = '';
    mdPane.style.transition = '';
  });
})();

// ═══════════════════════════════════════════════════════════
// BEFORE UNLOAD — prompt to save workspace
// ═══════════════════════════════════════════════════════════
// Browsers no longer allow custom messages in beforeunload dialogs.
// The best we can do is trigger the native "Leave site?" confirmation
// which gives the user a "Stay on page" option to go back and export.
// For a richer save prompt we intercept the custom save shortcut and
// also show a persistent reminder banner when files are open.
window.addEventListener('beforeunload', e => {
  if (!S.files.length) return;
  e.preventDefault();
  e.returnValue = '';   // required: triggers browser "Leave site?" dialog
});

function showLeaveWarning() {
  if (!S.files.length) return;
  // Show an in-app overlay only when navigating away via code (not browser UI)
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-title">Export before leaving?</div>
      <div class="modal-label" style="margin-bottom:16px">Your workspace is in memory only — it will be lost when you close this tab. Export a zip to save your work.</div>
      <div class="modal-actions">
        <button class="btn sm ghost" id="_lwc">Dismiss</button>
        <button class="btn sm primary" id="_lws">Export Workspace</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#_lws').onclick = () => { document.body.removeChild(overlay); exportWorkspace(); };
  overlay.querySelector('#_lwc').onclick = () => document.body.removeChild(overlay);
  overlay.onclick = () => document.body.removeChild(overlay);
}

// ═══════════════════════════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════════════════════════
document.addEventListener('keydown', e => {
  if (document.querySelector('.modal-overlay')) return;
  const mod = e.ctrlKey || e.metaKey;
  if (mod && e.key === 's') { e.preventDefault(); saveFile(); }
  if (mod && e.key === 'e') { e.preventDefault(); exportCurrentFile(); }
  if (mod && e.key === 'm') { e.preventDefault(); toggleSplit(); }
  if (mod && e.key === 'w') { e.preventDefault(); if (S.activeTab) closeTab(S.activeTab); }
  if (mod && e.key === 'f') { e.preventDefault(); toggleDrawer(); }
  if (e.key === 'Escape' && S.drawerOpen) closeDrawer();
});

// ═══════════════════════════════════════════════════════════
// CTRL+CLICK LINKS IN EDITOR
// ═══════════════════════════════════════════════════════════
document.getElementById('editor-pane').addEventListener('click', e => {
  if (!(e.ctrlKey || e.metaKey)) return;
  const a = e.target.closest('a[href]');
  if (!a) return;
  e.preventDefault();
  // Use the raw attribute so protocol-less URLs like "www.google.com" are
  // not resolved as relative paths against the page base URL.
  let url = a.getAttribute('href') || '';
  if (url && !/^[a-z][a-z\d+\-.]*:/i.test(url)) url = 'https://' + url;
  // Only open safe schemes — blocks javascript:, data:, vbscript:, etc.
  if (url && /^https?:|^mailto:/i.test(url)) window.open(url, '_blank', 'noopener,noreferrer');
});

// ═══════════════════════════════════════════════════════════
// DRAG & DROP FILES
// ═══════════════════════════════════════════════════════════
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  Array.from(e.dataTransfer.files).forEach(f => {
    if (f.name.endsWith('.md')) {
      const r = new FileReader();
      r.onload = ev => {
        const file = { id: uid(), name: f.name, folderId: null, htmlContent: mdToHtml(ev.target.result), lastModified: Date.now() };
        S.files.push(file);
        renderTree(); openFile(file.id);
      };
      r.readAsText(f);
    }
  });
});

// ═══════════════════════════════════════════════════════════
// WELCOME & INIT
// ═══════════════════════════════════════════════════════════
const WELCOME_HTML = `<h1>Welcome to editorapp</h1>
<p>A minimal, mobile-first documentation editor. Write in rich text — the Markdown source updates live alongside. Everything lives in a single <code>index.html</code> file you can self-host for free on GitHub Pages.</p>
<h2>Getting started</h2>
<p>Tap the <strong>☰ menu</strong> (top left) to open the file explorer. From there you can create files and folders, rename them, reorder them by dragging, and import or export your work. Hit the <strong>Markdown</strong> button (top right) to reveal the raw Markdown pane alongside the editor. On mobile, this swaps between the two views full-screen.</p>
<h2>The editor</h2>
<p>editorapp uses a rich text editor (Quill) as its primary surface. You write and format as you would in any word processor — headings, bold, italic, lists, blockquotes, code blocks, and links are all available from the toolbar. There is no need to think in Markdown syntax unless you want to.</p>
<p>Every keystroke is converted to clean Markdown in the background and reflected live in the split pane. You can also edit the Markdown directly in that pane and the rich text view will update after a short pause. Links in the editor open in a new tab on <strong>Ctrl+click</strong>.</p>
<h2>Keyboard shortcuts</h2>
<ul>
<li><code>⌘/Ctrl + M</code> — toggle Markdown split view</li>
<li><code>⌘/Ctrl + S</code> — save current file</li>
<li><code>⌘/Ctrl + E</code> — export current file as <code>.md</code></li>
<li><code>⌘/Ctrl + W</code> — close current tab</li>
<li><code>⌘/Ctrl + F</code> — toggle file explorer</li>
<li><code>Esc</code> — close file explorer</li>
</ul>
<h2>File organisation</h2>
<p>Files live inside a folder tree in the explorer drawer. You can nest folders to any depth. Drag a file or folder to reorder it — drop onto the middle of a folder to move inside it, or near the top or bottom edge to reorder above or below it. Moving a folder moves all its contents with it.</p>
<p>Each document is stored in memory during your session. Nothing is sent to a server. Use <strong>Export Workspace</strong> to download your entire folder structure as a <code>.zip</code> of <code>.md</code> files, preserving all paths. Use <strong>Import Workspace</strong> to restore it later.</p>
<h2>Hosting on GitHub Pages</h2>
<p>Because editorapp is a single self-contained <code>index.html</code> file with no backend and no build step, deployment is trivial:</p>
<ol>
<li>Create a new GitHub repository (or use an existing one).</li>
<li>Add <code>index.html</code> to the root of the repository.</li>
<li>Go to <strong>Settings → Pages</strong>, set the source to the <code>main</code> branch, root path.</li>
<li>GitHub will publish it at <code>https://&lt;your-username&gt;.github.io/&lt;repo-name&gt;</code> within a minute.</li>
</ol>
<p>To use a custom domain, add a <code>CNAME</code> file containing your domain name to the repository root, then point your DNS to GitHub's servers. HTTPS is provisioned automatically.</p>
<h2>Tips for good documentation</h2>
<p>Good documentation is written for a specific reader with a specific goal. Before writing, ask: who is this for, and what do they need to be able to do after reading it? Structure your answer around tasks, not features. Use short sentences. Prefer active voice. Put the most important information first.</p>
<p>Use headings to help readers scan — a reader should be able to understand the shape of a document from its headings alone without reading the body text. Use code blocks for anything a reader might copy. Use lists when you have more than two parallel items. Use bold sparingly, only for things that genuinely must not be missed.</p>
<p>Version your docs alongside your code. Outdated documentation is worse than no documentation because it actively misleads. A short accurate doc is always better than a long stale one.</p>
<h2>About</h2>
<p>editorapp is open source and MIT licensed. Contributions, issues, and forks are welcome. Built with <a href="https://quilljs.com">Quill</a>, <a href="https://github.com/mixmark-io/turndown">Turndown</a>, <a href="https://marked.js.org">Marked</a>, and <a href="https://stuk.github.io/jszip">JSZip</a> — all loaded from CDN, no <code>npm install</code> required.</p>
`;

function init() {
  const fetches = PRELOAD_FILES.map(name =>
    fetch(name)
      .then(r => r.ok ? r.text() : Promise.reject())
      .then(md => ({ name, md }))
      .catch(() => null)
  );

  Promise.all(fetches).then(results => {
    const loaded = results.filter(Boolean);
    if (loaded.length === 0) {
      // Fallback when files can't be fetched (e.g. file:// protocol)
      const welcome = {
        id: uid(), name: 'welcome.md', folderId: null,
        htmlContent: WELCOME_HTML, lastModified: Date.now(),
      };
      S.files.push(welcome);
      renderTree();
      openFile(welcome.id);
    } else {
      loaded.forEach(({ name, md }) => {
        const file = { id: uid(), name, folderId: null, htmlContent: mdToHtml(md), lastModified: Date.now() };
        S.files.push(file);
        S.openTabs.push(file.id);
      });
      renderTree();
      openFile(S.files[0].id);   // activates first file; tabs already pre-populated
    }

    if (window.innerWidth > 1200) {
      // Large desktop: show sidebar + markdown pane for 5 s then collapse
      openDrawer();
      toggleSplit();
      setTimeout(() => {
        closeDrawer();
        if (S.splitOpen) toggleSplit();
      }, 5000);
    } else if (window.innerWidth > 767) {
      openDrawer();
    }
  });
}

init();
</script>
</body>
</html>
